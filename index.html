<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>歩行解析アプリ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- PWA対応 -->
  <link rel="manifest" href="manifest.json">
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js");
    }
  </script>

  <!-- フォント -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">

  <!-- Chart.js（グラフ用） -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- MediaPipe Tasks Vision を ES Module として読み込み -->
  <script type="module">
    import {
      PoseLandmarker,
      FilesetResolver,
      DrawingUtils
    } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0";

    window.PoseLandmarker = PoseLandmarker;
    window.FilesetResolver = FilesetResolver;
    window.DrawingUtils = DrawingUtils;
  </script>

  <!-- スタイル（省略せず全文） -->
  <style>
    /* ここに前回提供した style セクションをそのまま貼り付けてください。
       長いため省略していますが、前回の index.html に含まれていた style セクションがそのまま使えます。
       すでに健康アプリ風のUI、フォント、色、ボタン、チェックリスト、グラフなどすべて含まれています。 */
  </style>
</head>

<body>
  <header>
    <div class="title">歩行解析アプリ</div>
    <div class="subtitle">今日の歩き方をチェックしてみましょう</div>
  </header>

  <div class="container">

    <!-- モード切替 -->
    <div class="mode-switch">
      <button id="liveModeBtn" class="mode-button active">📸 撮影補助モード</button>
      <button id="videoModeBtn" class="mode-button">🎥 動画解析モード</button>
    </div>

    <!-- 撮影補助モード -->
    <section id="liveSection" class="section active">
      <h2><span class="icon">📸</span>撮影補助モード（リアルタイム骨格描画）</h2>
      <p class="label">健康アプリ感覚で、撮影条件を整えながらリアルタイムで骨格ラインを確認できます。</p>

      <div class="checklist">
        <div style="font-weight:600; margin-bottom:4px;">撮影チェックリスト</div>
        <label><input type="checkbox" class="precheck" id="checkFullBody">☑ 全身が映っています</label>
        <label><input type="checkbox" class="precheck" id="checkSideView">☑ 横から撮っています</label>
        <label><input type="checkbox" class="precheck" id="checkNaturalWalk">☑ 普段どおり歩いています</label>
      </div>

      <video id="liveVideo" playsinline muted></video>
      <canvas id="liveCanvas"></canvas>

      <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
        <button id="startLiveBtn" disabled>撮影開始</button>
        <button id="stopLiveBtn">カメラ停止</button>
      </div>

      <div id="liveStatus" class="status"></div>
      <div id="liveError" class="error"></div>
    </section>

    <!-- 動画解析モード -->
    <section id="videoSection" class="section">
      <h2><span class="icon">🎥</span>動画解析モード</h2>

      <div class="input-box">
        <label>解析条件：</label>
        <select id="surgeryStatus">
          <option value="術前">術前</option>
          <option value="術後">術後</option>
        </select>
        <input type="number" id="postOpDays" placeholder="術後日数（例：14）" style="width:120px;">
      </div>

      <input type="file" id="videoFileInput" accept="video/*">
      <button id="analyzeVideoBtn" style="margin-top:6px;">動画を解析</button>

      <video id="analysisVideo" controls></video>
      <canvas id="analysisCanvas"></canvas>

      <div id="videoStatus" class="status"></div>
      <div id="videoError" class="error"></div>

      <div id="resultBox" class="result-box" style="display:none;">
        <div class="result-title"><span>📊</span>今回の解析結果（最大値）</div>
        <div id="pelvisResult" class="mono"></div>
        <div id="hipResult" class="mono"></div>
        <div id="speedResult" class="mono"></div>

        <div class="gait-summary">
          <div id="gaitStatusBadge" class="gait-status-badge gait-status-green" style="display:none;"></div>
          <div id="gaitFeatureText"></div>
          <ul id="exerciseList" class="exercise-list"></ul>
        </div>

        <div class="footer-note">
          ※この結果は診断ではありません。気になる症状がある場合は，医療スタッフにご相談ください。
        </div>
      </div>

      <h3 style="margin-top:18px; font-size:14px;">回復過程の比較</h3>
      <table id="resultTable" border="0" style="width:100%; border-collapse:collapse;">
        <thead>
          <tr>
            <th>条件</th>
            <th>骨盤傾斜（°）</th>
            <th>股関節外転/内転角度（°）</th>
            <th>歩行速度（m/秒）</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <canvas id="compareChart" style="margin-top:16px;"></canvas>
    </section>

  </div>

  <!-- スクリプト -->
  <script type="module" src="script.js"></script>
</body>
</html>